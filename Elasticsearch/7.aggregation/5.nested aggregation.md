### **ğŸ“Œ Nested Aggregation in Elasticsearch**

Elasticsearch me **nested objects** ko efficiently query karne ke liye **nested aggregation** ka use hota hai.  
Agar documents ke andar **nested fields** hain, toh normal aggregations unhe sahi se handle nahi kar sakti.  
Isliye, **nested aggregation** ka use hota hai jo **documents ke andar ke nested fields** ko process karne me madad karti hai. ğŸš€

---

## **ğŸ”¹ Kab Use Karna Chahiye?**

âœ” Jab aapke documents me **nested objects (arrays of objects)** ho.  
âœ” Jab aapko **inner objects pe aggregation** perform karni ho.  
âœ” Jab aap **parent document ka data nahi, balki uske nested fields ka aggregated result** chahiye.

---

## **âœ… Example: Nested Aggregation**

### **ğŸ“Œ Sample Index Mapping (Nested Field Example)**

Maan lo ki humare documents me ek **nested field** hai `items`, jo har order ke multiple items ko store karta hai:

```json
PUT index_name
{
  "mappings": {
    "properties": {
      "order_id": { "type": "keyword" },
      "customer": { "type": "keyword" },
      "items": {
        "type": "nested",  // ğŸ‘ˆ Yeh ek nested field hai!
        "properties": {
          "product": { "type": "keyword" },
          "quantity": { "type": "integer" },
          "price": { "type": "float" }
        }
      }
    }
  }
}
```

### **ğŸ“Œ Example Query: Total Sales for Each Product (Inside Nested Field)**

```json
GET index_name/_search
{
  "size": 0,
  "aggs": {
    "nested_items": {
      "nested": { "path": "items" },  // ğŸ‘ˆ Yeh "items" nested field ko target karega.
      "aggs": {
        "product_sales": {
          "terms": { "field": "items.product" },  // ğŸ‘ˆ Bucket Aggregation on product
          "aggs": {
            "total_revenue": {
              "sum": { "field": "items.price" }  // ğŸ‘ˆ Metric Aggregation
            }
          }
        }
      }
    }
  }
}
```

---

## **ğŸ“Œ Is Query Ka Kya Hoga?**

1ï¸âƒ£ **"items" field ek nested field hai, toh usko directly aggregate nahi kar sakte.**

- Pehle `nested` aggregation ka use karke us field ke andar jaate hain.

2ï¸âƒ£ **`terms` aggregation se products ke basis pe grouping hoti hai.**

- Har product ka ek alag bucket create hota hai.

3ï¸âƒ£ **`sum` aggregation se total revenue calculate hota hai.**

- Har product ke total price ka sum hota hai.

---

### **ğŸ“Œ Expected Output Example**

```json
{
  "aggregations": {
    "nested_items": {
      "doc_count": 1000,
      "product_sales": {
        "buckets": [
          {
            "key": "Laptop",
            "doc_count": 300,
            "total_revenue": { "value": 150000.0 }
          },
          {
            "key": "Phone",
            "doc_count": 500,
            "total_revenue": { "value": 200000.0 }
          }
        ]
      }
    }
  }
}
```

---
